Load libraries
```{r}
library(tidyverse)
library(dplyr)
library(here)
library(writexl)
library(readxl)
```

Load the individual game_info and ball_pos game_events files into two full dataframes.
```{r}
data_folder <- here("Provided Data", "smt_data_challenge_2023")
game_info_folder <- here(data_folder, "game_info")
game_info <- list.files(here(game_info_folder), full.names = T) %>%
  lapply(read_csv, show_col_types = FALSE, col_select = -1) %>%
  bind_rows()
ball_info_folder <- here(data_folder, "ball_pos")
ball_pos <- list.files(here(ball_info_folder), full.names = T) %>%
  lapply(read_csv, show_col_types = FALSE, col_select = -1) %>%
  bind_rows()

player_pos <- list.files('C:/Users/barto/Downloads/Sports Analytics/SMT 2023/Provided Data/smt_data_challenge_2023/player_pos', pattern = '*.csv',
                              recursive = T, full.names = T) %>% #head() %>%
  lapply(read_csv, show_col_types = FALSE, col_select = -1) %>%
  bind_rows()

game_events <- list.files('C:/Users/barto/Downloads/Sports Analytics/SMT 2023/Provided Data/smt_data_challenge_2023/game_events',
                              recursive = T, full.names = T) %>% #head() %>%
  lapply(read_csv, show_col_types = FALSE, col_select = -1) %>%
  bind_rows()
```

Load the dataframe that has the identified throws to first.
```{r}
throws_to_first <- read_xlsx("throws_to_first.xlsx")
# Fix timestamp values to not be of type character
throws_to_first$timestamp <- as.numeric(throws_to_first$timestamp)
```

We need to know the player at first base for each throw and this is in game_info. There are missing plays in game_info though. This identifies which plays in throws_to_first are not currently present in game_info.
```{r}
missing_plays <- data.frame(game_str = character(),
                            missing_play = integer())
unique_games <- unique(throws_to_first$game_str)
for (game in unique_games) {
  throws_to_first_plays <- unique(throws_to_first$play_id[throws_to_first$game_str == game])
  game_info_plays <- unique(game_info$play_per_game[game_info$game_str == game])
  missing_play <- setdiff(throws_to_first_plays, game_info_plays) # Find which plays are in throws_to_first but not in game_info
  missing_plays <- rbind(missing_plays,
                         data.frame(game_str = rep(game, length(missing_play)),
                                    missing_play = missing_play))
  }
```

The function insert_row adds the desired row of information based on the game_str, the missing play_per_game, and the play_per_game it will be assumed to most resemble.
```{r}
insert_row <- function(df, game_str, play_per_game, play_per_game_to_copy) {
  insert_index <- which(df$game_str == game_str & df$play_per_game == play_per_game_to_copy)
  new_row <- df[insert_index, ]
  new_row$play_per_game <- play_per_game
  new_df <- rbind(df[1:insert_index, ], new_row, df[(insert_index + 1):nrow(df), ])
  return(new_df)
}
```

There are 107 plays in throws_to_first that are not in game_info. Now they are manually added in to get which first baseman is involved in the play.
```{r}
game_info_updated <- game_info
game_info_updated <- insert_row(game_info_updated, "1900_01_TeamKJ_TeamB", 48, 47) # 47top, 49top
game_info_updated <- insert_row(game_info_updated, "1900_02_TeamKJ_TeamB", 71, 69) # 69bot, 73bot
game_info_updated <- insert_row(game_info_updated, "1900_02_TeamKJ_TeamB", 179, 176) # 176top, 180top
game_info_updated <- insert_row(game_info_updated, "1900_02_TeamKJ_TeamB", 282, 281) # 281top, 283top
game_info_updated <- insert_row(game_info_updated, "1900_03_TeamKJ_TeamB", 138, 137) # 137bot, 139top. 123604ms longer delta_t btwn 138-139 vs 137-138 suggests 138bot
game_info_updated <- insert_row(game_info_updated, "1900_03_TeamKJ_TeamB", 165, 164) # 164bot, 167bot
game_info_updated <- insert_row(game_info_updated, "1900_04_TeamKK_TeamB", 220, 219) # 219top, 221top
game_info_updated <- insert_row(game_info_updated, "1900_05_TeamKK_TeamB", 9, 6) # 6top, 11top
game_info_updated <- insert_row(game_info_updated, "1900_05_TeamKK_TeamB", 44, 43) # 43top, 47top
game_info_updated <- insert_row(game_info_updated, "1900_06_TeamKL_TeamB", 146, 145) # 145top, 147top
game_info_updated <- insert_row(game_info_updated, "1900_08_TeamKL_TeamB", 207, 206) # 206top, 209top
game_info_updated <- insert_row(game_info_updated, "1900_09_TeamKK_TeamB", 170, 169) # 169top, 176bot. Delta_t is longest btwn 175-176 so 170top
game_info_updated <- insert_row(game_info_updated, "1901_01_TeamLG_TeamA3", 21, 18) # 18top, 23top
game_info_updated <- insert_row(game_info_updated, "1901_02_TeamLG_TeamA3", 76, 69) # 69bot, 99bot
game_info_updated <- insert_row(game_info_updated, "1901_02_TeamLG_TeamA3", 78, 69) # 69bot, 99bot
game_info_updated <- insert_row(game_info_updated, "1901_02_TeamLG_TeamA3", 85, 69) # 69bot, 99bot
game_info_updated <- insert_row(game_info_updated, "1901_02_TeamLG_TeamA3", 96, 69) # 69bot, 99bot
game_info_updated <- insert_row(game_info_updated, "1901_02_TeamLG_TeamA3", 98, 69) # 69bot, 99bot
game_info_updated <- insert_row(game_info_updated, "1901_02_TeamLG_TeamA3", 150, 147) # 147bot, 153bot
game_info_updated <- insert_row(game_info_updated, "1901_02_TeamLG_TeamA3", 269, 268) # 268bot, 270bot
game_info_updated <- insert_row(game_info_updated, "1901_03_TeamLG_TeamA3", 3, 11) # 11top1
game_info_updated <- insert_row(game_info_updated, "1901_03_TeamLG_TeamA3", 8, 11) # 11top1
game_info_updated <- insert_row(game_info_updated, "1901_03_TeamLG_TeamA3", 21, 20) # 20top, 22top
game_info_updated <- insert_row(game_info_updated, "1901_03_TeamLG_TeamA3", 214, 213) # 213bot, 221bot
game_info_updated <- insert_row(game_info_updated, "1901_04_TeamLI_TeamA3", 237, 236) # 236bot, 238top. 237bot because has same runner situation as 236
game_info_updated <- insert_row(game_info_updated, "1901_07_TeamLK_TeamB", 154, 153) # 153top, 155top
game_info_updated <- insert_row(game_info_updated, "1901_07_TeamLK_TeamB", 188, 187) # 187top, 189top
game_info_updated <- insert_row(game_info_updated, "1901_07_TeamLK_TeamB", 192, 191) # 191top, 193top
game_info_updated <- insert_row(game_info_updated, "1901_10_TeamLJ_TeamB", 148, 147) # 147bot, 149bot
game_info_updated <- insert_row(game_info_updated, "1901_10_TeamLJ_TeamB", 181, 178) # 178bot, 182bot
game_info_updated <- insert_row(game_info_updated, "1901_10_TeamLJ_TeamB", 244, 242) # 242bot, 245bot
game_info_updated <- insert_row(game_info_updated, "1901_11_TeamLJ_TeamB", 139, 137) # 137bot, 143top. 139bot because it's third out since 139 had r1, r2 and 140 has no runners on
game_info_updated <- insert_row(game_info_updated, "1901_11_TeamLJ_TeamB", 146, 145) # 145top, 148top
game_info_updated <- insert_row(game_info_updated, "1901_14_TeamLL_TeamB", 164, 163) # 163top, 165top
game_info_updated <- insert_row(game_info_updated, "1901_16_TeamLH_TeamA3", 188, 187) # 187top, 189top
game_info_updated <- insert_row(game_info_updated, "1901_16_TeamLH_TeamA3", 211, 210) # 210top, 213top
game_info_updated <- insert_row(game_info_updated, "1902_04_TeamML_TeamB", 43, 42) # 42bot, 44bot
game_info_updated <- insert_row(game_info_updated, "1902_04_TeamML_TeamB", 53, 46) # 46bot, 54top. 95400ms longer delta_t btwn 53-54 than 48-49 suggests 53bot
game_info_updated <- insert_row(game_info_updated, "1902_04_TeamML_TeamB", 80, 79) # 79bot, 81bot
game_info_updated <- insert_row(game_info_updated, "1902_05_TeamML_TeamB", 27, 26) # 26bot, 28bot
game_info_updated <- insert_row(game_info_updated, "1902_05_TeamML_TeamB", 60, 58) # 58top, 61top
game_info_updated <- insert_row(game_info_updated, "1902_05_TeamML_TeamB", 165, 163) # 163top, 166top
game_info_updated <- insert_row(game_info_updated, "1902_05_TeamML_TeamB", 9, 8) # 8top, 10top
game_info_updated <- insert_row(game_info_updated, "1902_05_TeamML_TeamB", 240, 239) # 239bottom, 254top. 240bot because 239 is pickoff at first just like 240 so inning change couldn't have occurred
game_info_updated <- insert_row(game_info_updated, "1902_07_TeamMJ_TeamB", 25, 24) # 24bot, 26bot
game_info_updated <- insert_row(game_info_updated, "1902_07_TeamMJ_TeamB", 101, 100) # 100top, 102top
game_info_updated <- insert_row(game_info_updated, "1902_08_TeamMJ_TeamB", 70, 69) # 69bot, 71bot
game_info_updated <- insert_row(game_info_updated, "1902_08_TeamMJ_TeamB", 79, 78) # 78top, 80top
game_info_updated <- insert_row(game_info_updated, "1902_08_TeamMJ_TeamB", 101, 100) # 100bot, 102bot
game_info_updated <- insert_row(game_info_updated, "1902_08_TeamMJ_TeamB", 132, 131) # 131bot, 133bot
game_info_updated <- insert_row(game_info_updated, "1902_09_TeamMJ_TeamB", 40, 39) # 39top, 41top
game_info_updated <- insert_row(game_info_updated, "1902_09_TeamMJ_TeamB", 189, 188) # 188bot, 190bot
game_info_updated <- insert_row(game_info_updated, "1902_09_TeamMJ_TeamB", 199, 198) # 198bot, 200bot
game_info_updated <- insert_row(game_info_updated, "1902_09_TeamMJ_TeamB", 293, 292) # 292top, 294top
game_info_updated <- insert_row(game_info_updated, "1902_09_TeamMJ_TeamB", 295, 294) # 294top, 296top
game_info_updated <- insert_row(game_info_updated, "1902_10_TeamMI_TeamA3", 145, 144) # 144bot, 146bot
game_info_updated <- insert_row(game_info_updated, "1902_10_TeamMI_TeamA3", 282, 279) # 279bot9
game_info_updated <- insert_row(game_info_updated, "1902_12_TeamMI_TeamA3", 47, 46) # 46bot, 48bot
game_info_updated <- insert_row(game_info_updated, "1902_12_TeamMI_TeamA3", 58, 57) # 57bot, 59bot
game_info_updated <- insert_row(game_info_updated, "1902_12_TeamMI_TeamA3", 60, 59) # 59bot, 61bot
game_info_updated <- insert_row(game_info_updated, "1902_12_TeamMI_TeamA3", 70, 69) # 69top, 71top
game_info_updated <- insert_row(game_info_updated, "1902_13_TeamMD_TeamA2", 79, 78) # 78bot, 80bot
game_info_updated <- insert_row(game_info_updated, "1902_13_TeamMD_TeamA2", 88, 86) # 86top, 89top
game_info_updated <- insert_row(game_info_updated, "1902_13_TeamMK_TeamB", 6, 5) # 5top, 7top
game_info_updated <- insert_row(game_info_updated, "1902_13_TeamMK_TeamB", 43, 42) # 42top, 45bot. 114650ms longer delta_t btwn 43-44 vs 42-43 suggests 43top
game_info_updated <- insert_row(game_info_updated, "1902_13_TeamMK_TeamB", 130, 129) # 129top, 132bot. 93250ms longer delta_t btwn 130-131 vs 129-130 suggests 130top
game_info_updated <- insert_row(game_info_updated, "1902_14_TeamMD_TeamA2", 66, 67) # 57top, 67bot. 89050ms longer delta_t btwn 65-66 vs 58-59 suggests 66bot
game_info_updated <- insert_row(game_info_updated, "1902_14_TeamMD_TeamA2", 314, 312) # 312top, 315top
game_info_updated <- insert_row(game_info_updated, "1902_14_TeamMK_TeamB", 50, 49) # 49bot, 51bot
game_info_updated <- insert_row(game_info_updated, "1902_14_TeamMK_TeamB", 53, 52) # 52bot, 54bot
game_info_updated <- insert_row(game_info_updated, "1902_14_TeamMK_TeamB", 55, 54) # 54bot, 56bot
game_info_updated <- insert_row(game_info_updated, "1902_14_TeamMK_TeamB", 59, 58) # 58bot, 60bot
game_info_updated <- insert_row(game_info_updated, "1902_14_TeamMK_TeamB", 298, 297) # 297top9
game_info_updated <- insert_row(game_info_updated, "1902_15_TeamMK_TeamB", 52, 51) # 51top, 53top
game_info_updated <- insert_row(game_info_updated, "1902_16_TeamMD_TeamA2", 77, 74) # 74top, 78top
game_info_updated <- insert_row(game_info_updated, "1902_17_TeamMB_TeamA1", 192, 191) # 191bot, 193bot
game_info_updated <- insert_row(game_info_updated, "1902_17_TeamMB_TeamA1", 208, 205) # 205top, 209top
game_info_updated <- insert_row(game_info_updated, "1902_18_TeamMB_TeamA1", 145, 144) # 144bot, 146bot
game_info_updated <- insert_row(game_info_updated, "1902_20_TeamME_TeamA2", 23, 22) # 22bot, 24bot
game_info_updated <- insert_row(game_info_updated, "1902_20_TeamME_TeamA2", 193, 178) # 178bot, 197bot
game_info_updated <- insert_row(game_info_updated, "1902_20_TeamME_TeamA2", 273, 270) # 270bot, 294top. Low maximum delta_t of 33200ms btwn plays from 270-273 suggests 273bot
game_info_updated <- insert_row(game_info_updated, "1902_20_TeamME_TeamA2", 274, 270) # 270bot, 294top. Pickoff attempt with runner on first so no inning switch could have occurred
game_info_updated <- insert_row(game_info_updated, "1902_20_TeamME_TeamA2", 275, 270) # 270bot, 294top. Pickoff attempt with runner on first so no inning switch could have occurred
game_info_updated <- insert_row(game_info_updated, "1902_20_TeamME_TeamA2", 293, 294) # 270bot, 294top. 19000ms delta_t btwn 293-294 suggests inning change already occurred so 293top
game_info_updated <- insert_row(game_info_updated, "1902_21_TeamME_TeamA2", 7, 6) # 6top, 8top
game_info_updated <- insert_row(game_info_updated, "1902_21_TeamME_TeamA2", 10, 9) # 9top, 11top
game_info_updated <- insert_row(game_info_updated, "1902_21_TeamME_TeamA2", 25, 24) # 24bot, 32top. 32950ms delta_t btwn 24-25 suggests inning change happens after so 25bot
game_info_updated <- insert_row(game_info_updated, "1902_21_TeamME_TeamA2", 76, 75) # 75bot, 89top. 98200ms longer delta_t btwn 82-83 vs 78-79 suggests 76bot
game_info_updated <- insert_row(game_info_updated, "1902_21_TeamME_TeamA2", 79, 75) # 75bot, 89top. 98200ms longer delta_t btwn 82-83 vs 78-79 suggests 79bot
game_info_updated <- insert_row(game_info_updated, "1902_21_TeamME_TeamA2", 86, 89) # 75bot, 89top. 98200ms longer delta_t btwn 82-83 vs 78-79 suggests 86top
game_info_updated <- insert_row(game_info_updated, "1902_24_TeamMA_TeamA1", 227, 226) # 226top, 228top
game_info_updated <- insert_row(game_info_updated, "1902_25_TeamMH_TeamA3", 139, 138) # 138bot, 140bot
game_info_updated <- insert_row(game_info_updated, "1902_26_TeamMC_TeamA1", 8, 6) # 6top, 18top
game_info_updated <- insert_row(game_info_updated, "1902_26_TeamMC_TeamA1", 254, 253) # 253bot, 255bot
game_info_updated <- insert_row(game_info_updated, "1902_26_TeamMH_TeamA3", 56, 55) # 55top, 57top
game_info_updated <- insert_row(game_info_updated, "1902_26_TeamMH_TeamA3", 111, 6) # 110bot, 112bot
game_info_updated <- insert_row(game_info_updated, "1902_26_TeamMH_TeamA3", 279, 278) # 278bot, 280bot
game_info_updated <- insert_row(game_info_updated, "1902_29_TeamMF_TeamA2", 92, 86) # 86bot, 99top. 103250ms longer delta_t btwn 97-98 vs 95-96 suggests 92bot
game_info_updated <- insert_row(game_info_updated, "1902_29_TeamMF_TeamA2", 95, 86) # 86bot, 99top. 103250ms longer delta_t btwn 97-98 vs 95-96 suggests 95bot
game_info_updated <- insert_row(game_info_updated, "1902_29_TeamMF_TeamA2", 97, 86) # 86bot, 99top. 103250ms longer delta_t btwn 97-98 vs 95-96 suggests 97bot
game_info_updated <- insert_row(game_info_updated, "1902_29_TeamMF_TeamA2", 132, 131) # 131bot, 133bot
game_info_updated <- insert_row(game_info_updated, "1902_30_TeamMF_TeamA2", 155, 153) # 153bot, 158bot
game_info_updated <- insert_row(game_info_updated, "1902_31_TeamMF_TeamA2", 75, 73) # 73top, 85bot. 94900ms longer delta_t btwn 84-85 vs 77-78 suggests 75top
game_info_updated <- insert_row(game_info_updated, "1903_02_TeamNE_TeamA2", 39, 38) # 38top, 40top
game_info_updated <- insert_row(game_info_updated, "1903_07_TeamND_TeamA2", 166, 165) # 165top, 167top
game_info_updated <- insert_row(game_info_updated, "1903_17_TeamNI_TeamA3", 98, 110) # 96bot, 99top. 98top because 96 had runner on 2nd that didn't get thrown out on the play and 97 is pitch with no one on (so 96 was third out). Chose play 110 because play 99 has a glitch that has it as two rows, one in bottom and one in top. 110 is the next time it is in the top without a glitched double row.
game_info_updated <- insert_row(game_info_updated, "1903_25_TeamNH_TeamA3", 262, 261) # 261top, 263top
```

These are the 6 plays that have been removed.
```{r}
throws_to_first <- throws_to_first[
  !(throws_to_first$game_str == "1902_17_TeamMB_TeamA1" & throws_to_first$play_id == 155) # Pitcher covers first 
  & !(throws_to_first$game_str == "1903_09_TeamNJ_TeamB" & (throws_to_first$play_id == 156 # Second baseman covers first
  | throws_to_first$play_id == 215))  # Second baseman covers first
  & !(throws_to_first$game_str == "1902_18_TeamMB_TeamA1" & throws_to_first$play_id == 31) # First base cutoff
  & !(throws_to_first$game_str == "1903_19_TeamNL_TeamB" & throws_to_first$play_id == 304) # First base cutoff
  & !(throws_to_first$game_str == "1903_24_TeamNA_TeamA1" & throws_to_first$play_id == 76), ] # First base back pick from catcher
```

Feature engineering - This constructs a dataframe with more information about each throw to use for modelling.
```{r}
throws_info <- throws_to_first %>%
  group_by(game_str, play_id) %>%
  mutate(at_teamA1 = ifelse(grepl("_TeamA1", game_str), 1, 0),
         at_teamA2 = ifelse(grepl("_TeamA2", game_str), 1, 0),
         at_teamA3 = ifelse(grepl("_TeamA3", game_str), 1, 0), # This makes a dummy variable for what stadium the throw is in. at_teamB not required because if 0 across A1, A2, A3 then at team B.
         has_bounce = ifelse(any(events == "[16]" & is_closer & (!(any(events == '[10]')) | row_number() < which(events == '[10]')[1]) & (!(any(events == '[9]')) | row_number() < which(events == '[9]')[1])), 1, 0), # If the ball bounces and is getting closer to first base before it deflects off a wall, glove, or person then it has_bounce.
         bounce_count = sum(events == "[16]" & is_closer & (!(any(events == '[10]')) | row_number() < which(events == '[10]')[1]) & (!(any(events == '[9]')) | row_number() < which(events == '[9]')[1])), # This counts how many times a throw bounced following the previously explained conditions. Interestingly, no throw had more than one bounce under those conditions.
         was_caught = ifelse(any(((events == '[2]' & player_position == '[3]') | (events == '[2, 5]' & player_position == '[3, 0]'))  & ((!(any(events == '[10]')) | row_number() < which(events == '[10]')[1])) & ((!(any(events == '[9]')) | row_number() < which(events == '[9]')[1]))), 1, 0), # If the ball was acquired by the first baseman before it deflects off a wall, glove, or person then it was_caught.
         next_event_index = which(events != '[]')[1],
         duration = timestamp - timestamp[next_event_index],
         distance = sqrt((ball_x - ball_x[next_event_index])^2 + (ball_y - ball_y[next_event_index])^2), # This distance is from the throw to the next event which is either an acquisition, bounce, or deflection.
         velocity = (distance / duration) * (1000 * 3600 / 5280)) %>% # Velocity is converted from ft/ms to mph.
  filter(events != '[]') %>%
  mutate(throw_duration = lead(duration),
         throw_distance = lead(distance),
         throw_velocity = lead(velocity),
         next_event = lead(events)) %>%
  slice_head(n = 1)
throws_info <- left_join(throws_info, game_info_updated, by = c("game_str", "play_id" = "play_per_game")) %>% # This gets the player who is at first base on the play.
  distinct(play_id, game_str, events, player_position, first_base, Ellipsoid, Ellipsoidx, Ellipsoidy, Ellipsoidz, has_bounce, bounce_count, was_caught, throw_velocity, throw_distance, throw_duration, at_teamA1, at_teamA2, at_teamA3)
write_csv(throws_info, "throws_info.csv")
```